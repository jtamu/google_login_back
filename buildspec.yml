version: 0.2

phases:
  install:
    on-failure: ABORT
    commands:
      - pip install -r requirements.txt

  pre_build:
    on-failure: ABORT
    commands:
      - TEMP_ROLE=$(aws sts assume-role --role-arn $ASSUME_ROLE_ARN --role-session-name test)
      - export AWS_ACCESS_KEY_ID=$(echo "${TEMP_ROLE}" | jq -r '.Credentials.AccessKeyId')
      - export AWS_SECRET_ACCESS_KEY=$(echo "${TEMP_ROLE}" | jq -r '.Credentials.SecretAccessKey')
      - docker compose up dynamo-test -d
      - docker compose run python ./test.sh
      - docker compose stop
      - aws s3 cp s3://jtamu-chalice-deployed-bucket01/google_login_back/dev.json .chalice/deployed/dev.json || true

  build:
    on-failure: ABORT
    commands:
      - chalice deploy

  post_build:
    on-failure: ABORT
    commands:
      - aws s3 cp .chalice/deployed/dev.json s3://jtamu-chalice-deployed-bucket01/google_login_back/dev.json
      - python create_table.py
